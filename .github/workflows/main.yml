name: Kernel Builder.

on:
  workflow_dispatch

jobs:
  build:

    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
    - uses: actions/checkout@v2
    - name: for aarch64
      run: sudo apt-get install ccache && mkdir -p ../PLATFORM/prebuilts/gcc/linux-x86/aarch64 && git clone  https://github.com/djb77/aarch64-linux-android-4.9 ../PLATFORM/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9
    
    - name: Make G9500 kernel
      run: |
        make clean && make mrproper
        export ARCH=arm64
        export BUILD_CROSS_COMPILE=$(pwd)/../PLATFORM/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-
        export BUILD_JOB_NUMBER=`grep processor /proc/cpuinfo|wc -l`
        export ANDROID_MAJOR_VERSION=p
        export PLATFORM_VERSION=9.0.0
        export CROSS_COMPILE=../PLATFORM/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-
        mkdir out
        chmod -R 777 out
        make -C $(pwd) O=out -j32 ARCH=arm64 CROSS_COMPILE=$(pwd)/../PLATFORM/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android- dreamqlte_chn_open_defconfig
        make -C $(pwd) O=out -j32 ARCH=arm64 CROSS_COMPILE=$(pwd)/../PLATFORM/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-
        cp out/arch/arm64/boot/Image $(pwd)/arch/arm64/boot/Image
        
    - uses: actions/upload-artifact@v2
      with:
        name: Image.gz-dtb
        path: out/arch/arm64/boot/Image        
